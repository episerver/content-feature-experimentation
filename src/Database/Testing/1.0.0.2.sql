--beginvalidatingquery

		 select 1, 'Upgrading database'

--endvalidatingquery

-- Create MultivariateTest Tables to Store MultivariateTest Information.
DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'Testing.Migrations.Configuration'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '1'

IF @CurrentMigration < '201609291731241_AddKpiResults'
BEGIN
    CREATE TABLE [dbo].[tblABKeyFinancialResult] (
    [Id] [uniqueidentifier] NOT NULL,
    [KpiId] [uniqueidentifier] NOT NULL,
    [Total] [decimal](18, 2) NOT NULL,
    [VariantId] [uniqueidentifier] NOT NULL,
    [CreatedDate] [datetime] NOT NULL,
    [ModifiedDate] [datetime] NOT NULL,
    CONSTRAINT [PK_dbo.tblABKeyFinancialResult] PRIMARY KEY ([Id])
	)
	CREATE INDEX [IX_VariantId] ON [dbo].[tblABKeyFinancialResult]([VariantId])
	CREATE TABLE [dbo].[tblABKeyValueResult] (
		[Id] [uniqueidentifier] NOT NULL,
		[KpiId] [uniqueidentifier] NOT NULL,
		[Value] [float] NOT NULL,
		[VariantId] [uniqueidentifier] NOT NULL,
		[CreatedDate] [datetime] NOT NULL,
		[ModifiedDate] [datetime] NOT NULL,
		CONSTRAINT [PK_dbo.tblABKeyValueResult] PRIMARY KEY ([Id])
	)
	CREATE INDEX [IX_VariantId] ON [dbo].[tblABKeyValueResult]([VariantId])
	ALTER TABLE [dbo].[tblABKeyFinancialResult] ADD CONSTRAINT [FK_dbo.tblABKeyFinancialResult_dbo.tblABVariant_VariantId] FOREIGN KEY ([VariantId]) REFERENCES [dbo].[tblABVariant] ([Id]) ON DELETE CASCADE
	ALTER TABLE [dbo].[tblABKeyValueResult] ADD CONSTRAINT [FK_dbo.tblABKeyValueResult_dbo.tblABVariant_VariantId] FOREIGN KEY ([VariantId]) REFERENCES [dbo].[tblABVariant] ([Id]) ON DELETE CASCADE
	INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
	VALUES (N'201609291731241_AddKpiResults', N'Testing.Migrations.Configuration',  0x1F8B0800000000000400ED5D5B6FE4B6157E2FD0FF20E8A92D1C8FED7D498D99045E5F8241D66BC363BB455F16B4C4191391A8894839368AFEB23EE427E52FF47074232951A22EF6CE748D3C64CCCBC7DBB9F1E81CEE1FFFFD7DFAE37318384F386624A233F770FFC07530F5229FD0D5CC4DF8F2BBEFDD1F7FF8F39FA6E77EF8ECDCE7ED3E8876D093B299FBC8F9FA783261DE230E11DB0F8917472C5AF27D2F0A27C88F264707077F9F1C1E4E3040B880E538D39B847212E2CD1FF0E769443DBCE6090A2E231F072C2B879AC506D5F98C42CCD6C8C333F7FC9A2C700C33DEBF44F12F98C344F76F31DBFCFF0C05AE73121004D35AE060E93A88D288230E933EBE6378C1E388AE166B2840C1EDCB1A43BB250A18CE16735C36B75DD7C19158D7A4EC98437909E351D811F0F043B65113BD7BAFED768B8D84AD3C872DE72F62D59BED9CB9B05B271FC5D6B98E3EDAF169108B96ADDBBD9FA26E8E6DBF00DC73B2267B05C9006589FFF69CD324E0498C6714273C46C19E739D3C04C4FB19BFDC46BF603AA34910C8F38699439D520045D771B4C6317FB9C1CB6C3573DF75266ABF89DEB1E826F54997F95342E0F767181B3D04B8A08A4963F75BC2039C23006DC1825DE7123D7FC274C51F672EFC749D0BF28CFDBC2483BDA304580C3AF138C19D873DC3CC8BC93AA58AC183378F75F51BC5F1DB2FF12A262B425130E7381C78480BA0E8F2904028083215E4995574878BF99904297EDF822CEB8C744EFD5170AE6142C423EB0DE35EE3D8C394A355813BA7FCC35167D04F8871606AB224D8FFF8D240008707072390D9F9F31A7B1CFBF784111EC5A711E8076D01CD00279ED01E0DDD3BAE1F34D292F8A009F127FC8483E290221056DD8FE85F0B2F8AF14090395B90158513F150B9BA8F51146044BBAF2FC6406FE310604E27FDC03EA327B24A69578505E10DD4BC8C62D04B1E9E531F160E87CB5CE706079B0EEC91AC4B9E36B4FF22A9B98B380A6FA220D57DADEDBFDCA27885C556471D3A2DA20458D07E99F7282670A0C66565F5C66554EAEBA65D6D5437CDE9A4B411DA2C07C3468C684A1846F8566C0B58E44008C306EAA83B2F2824CE782BC990734F27C990F3655F96CB98784416CB10DF59CA5A070FB7470544B6CBC34C9439FB07A19275DEDB14886876FF67C326744FF06F0321FE1FA44D77855D234DCC5ABDC33C819F2EE016453D82821BCC80939B8C27ADE91759E2E8E2D1DCD660343574E86A30A580F7284870FBA2A4668D0BAA6F67588CA1F1082695B64DE35A531AF83722F57F5E93A17A03F6BEBC01628F84E2CFEB187E655ED3EF5D67E12101D8436AA6D433708EBB21380BF67B6D21546F9F5948AD01BC2B498571F956027EE7596BAE0A92A10E9777CE1C5193D673648BDAB5E3C62454795172EECED9458056E5579E71D8520CC91437F260BE74EEA88FE3E0052064FB593DC04B1C3EE03867318A3C4E9E60519B4D9CB907950357DA9FA8AD0F9B5B9F45B46C5BF5BEAAC8B1F708D07ED1FE43F5E4D233920B4F188B40168B5368F52A49B6B43A8F73EA3B7DAEEDCAC700A32BEB124E8EACE1ACE0E467EEDF2ABBD071F4C2985446CFEF08EA6087AE2E98AFE8190E30C78E384861759C22E621BFCAE6B0DBBE5A02B21CC7988A8F9E70D963408584F2AAE027547C45087A2C49C3B2542362AEC5A87ACD195E636009CA7B9CAFCD74726740754AC5C8DAB6B6EDE2742291742BA5576F890DB4D570655468A910CA9D28B7C183BC2B946A5CC2DB50A6F17C7681129BADEE6689676382EBB2B672C7ED2A666D9C0F366CB115946BB59E3793AFEDE7693315C970FE8A446D30589B69ABCD7AD58959B9F47525E436A7D32E1171F35ADE8C809BCF6FFB8837BD56401F0E3D4AEB1B71F4801816E5F8B9CE9D700795E9D5856511163AA909DC05E6B98DBE514BCC75CA4B5455B157C855C5307F90AF03355AD52DA394DFC3EB500B2E68413179BF0D33ADE8242B78D5076D80562484062B11858EDDF6C152EADAE543A74ED13D2F50C57E345145857D7ADE97A4C10A32D64599BA9376BB5CF3A1A676575B4C757B635D5A4849E5CDBB64B6CD5F6B575A9CB026BAB33521FB1991D2624D9CDD4A6D1666A3C501F5DE5493FFCCB4A136E64B7703A6B291AA0C6BDDC4169365D806E62EBE421D1675D3491A089E154C278688F1E9255AAF095D4911E45989B348C3C74FBF5B740FA50E538C89C76A22AA8BD916238118432BACD58A0FED3EBE2031E3B97A779D533FAC34D395BF4113E5A3A9FABD7A7EB952CADB8BDF59D0658BCBD328EFCA5DBD808586C206136BC62A7199FA3A22AA1F0528AEF966701A054948CDF6A0B977168B2D036445F6184A60B58CA454D8E365C1D3325256D401438B8456C0B43A7BD4CC3D2E8365459D30F248680D272FB6C72A62A165A4A2D01EC7180B2DE31A1BD98FA38747CBF07A5D875DA88D8256B6A4B685FD087561D2327E5DBD3D7A25685A86AE54DAE3E6E1D3325C5E668FA2C54F2BA246ADEAB062F9E39EB25AB9C21E4FFDC02703AA3555C4E94413C995BB6B451554BC01AA66B1D23B46EB7F644564BA4DF6D24CD660AFA4AA3287AFA2AB0C4E60334A4374AF0CDCD0EC9DCCADC9BC306647266B83556F47C6C6CEDB4CB675764C77FB4509A2D5A18A8A2EBA218FA555D5425EDA490796D1B49AFE2B2BECF1B2A05A19292B7A675F6BF635F80CC6D751BA1FB1AF7A6AC5791D16CFE2AE14FD911675101369B4A42225D2A20E445FFAE015C237BBE6CD58EFC45FF5F38C4FF8B297BB2FD137626C2FC167A1862AA106D59CD7668C7782EF48F01567A1DEA418BD701A6ACEC169E6A86B7F73A2E2B94B9B8820F0E8092EB5F1CC5DBC30303DF64583FDC5AFC16940B0B84AE60D2E115C2F816BD2903FF7E8E0F0487BA9627B5E8D9830E607358ECEDAA723D4037B8380E284925F132C3C095C105F3CECD506FA8462EF11C57F09D1F35FC77889C108D8F9B5856153AB7F4161F0E629AF291041E143DF4FF0E1371FE1FD84DE382DEF27F45964FDEB09F98156DF4FE846254D8F2568B3B581333F9DD067E9868713964184BA83A9EF26F4C3A87D36E181F458593590BF37CDD505F25B828D91A4BF83425BC9DDADC255026460B1F879E6FE7BD3FFD899FFF34B0AB1E75CC5A08F8F9D03E73FE367D437ADD386177790C6EAE3EADE69CA5A3E8DABA06BD2CBFB88713DB9BC97C0AC2696F7998A9256DE4B25ED1E53B5B9807682BF942CBEE1DC2A67E1FAAF9E85DB4B1C14288324C26ED2ABD17BF30DD2AA927DDACF6C7D27486B821C3F93300F077DF3FC279B08D9D1D217FB46FB1B83C2DE30E96F2732AB3AE5F86D07CD1561A93D130B7782A6CC5FDDB78F867A67E7753BC957956295EC8AE13981031345BF5A46DD16A6208D973FB74524A764DD0CCBDADB19526BFE06FBB5C9AC3ED3AD1A13AF9F6B25F12A57894D996CE9F739B02C1F2238FECCFFF6609BE8D66454754A75334EA36F729CCC4D8DE971C6910725D0D9E7CF35AD7C70B29D5DAE5DD3147628294F25772DB9A25F8E5D4D1A9015356E5396DD906DD158488FA7DCC534BA6E4BB2B1D15A63D27629316EF0F6D4481F43E4D2ABA4BB55235540134BFF860A58048CAC4A08F12FAA50EC293AB86833A7CB28B706B419E54D74A70DE6C807057D1273B2441E876A0F33B6F9B700B2379FCEC307ECCFE955C2D7098725E3F02150925F8449D134FE26A74F9DF3F46A135AC1C658024C93083FD315FD9890A07CABEAA2C6CF648010B6CA4F18CAD3B304D387E3D54B81F479F364960D50B67D8589758BC3750060EC8A2E90F4465787B9DD31FC09AF90F792071C9941DA0F42DDF6E91941AB18852CC328FBC39F40C37EF8FCC3FF00834636BA4A680000 , N'6.1.3-40302')
END


GO
