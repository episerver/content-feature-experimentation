--beginvalidatingquery
	if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_DatabaseVersion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
    begin
		 select 1, 'Upgrading database'
    end
    else
		select -1, 'Not an EPiServer database'
--endvalidatingquery

-- Create MultivariateTest Tables to Store MultivariateTest Information.
DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'KPI.Migrations.Configuration'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '0'

IF @CurrentMigration < '201604051658334_Initial'
BEGIN
    CREATE TABLE [dbo].[tblKeyPerformaceIndicator] (
        [Id] [uniqueidentifier] NOT NULL,
        [ClassName] [nvarchar](max) NOT NULL,
        [Properties] [nvarchar](max) NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblKeyPerformaceIndicator] PRIMARY KEY ([Id])
    )
	IF object_id('[dbo].[__MigrationHistory]') IS NULL
	BEGIN
		CREATE TABLE [dbo].[__MigrationHistory] (
			[MigrationId] [nvarchar](150) NOT NULL,
			[ContextKey] [nvarchar](300) NOT NULL,
			[Model] [varbinary](max) NOT NULL,
			[ProductVersion] [nvarchar](32) NOT NULL,
			CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY ([MigrationId], [ContextKey])
		)
	END
    INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
    VALUES (N'201604051658334_Initial', N'KPI.Migrations.Configuration',  0x1F8B0800000000000400CD57DB6EDB38107D5F60FF41E0D32E908A49FBD20DE4165939298CD48951A57DA7A59143941795A402FBDBFAB09FB4BFB043EB6AF9523B0D8A8501431ACE1C9E19CE85FAF7FB3FD1FBA514C11318CBB51A918BF09C04A0529D71B51891D2E5AFDE92F7EF7EFF2DBACEE432F8D2E8BDF17A68A9EC883C3A575C526AD34790CC8692A7465B9DBB30D592B24CD3D7E7E77FD18B0B0A0841102B08A24FA5725CC2FA055F63AD52285CC9C45467206C2DC795648D1ADC3109B660298CC8F58C276090713865E62B38241ADECE26E19809125C09CE905202222701534A3BE690F0E5670B89335A2D9202054C3CAC0A40BD9C090BB523979DFAB13E9DBFF63ED1CEB0814A4BEBB43C11F0E24D1D243A347F56A8491B440CE33586DBADBCD7EB508E0846EBB6E024186E75190BE3D50EC6395C9F5258619C05283D6B530333C8FFCE82B814AE343052503AC3C459302BE782A7B7B07AD05F418D5429449F23B2C4B50D018A66461760DCEA13E435F3494602BA69478786AD59CFA6F2EA43C9F1F90EF76673016D06D083E6B160D6FAC706057309C34182295B7E04B5708F23828F24B8E14BC81A490DFD59712C273472A68493B7AE5F39D85FBF776C8039C8C6F8D76CEE9F1FB83C1D0B3386E7FC596011EDB2773BA7B17538C6159836B11D9B330B5E0E4BB723C3B117D4496EEBC06C32AF7013703522E63806BFE350B597B0A9A05D545B525D23A355276B3A1EDDD3F2A2292B0A3CDF5E0BAC254152F5BFF855727A3F9015064DED8EB6D0B26D7772DAB0050C56716B647AC38D754D90491067724B6D78047BC2DBECD68BF2B0FABBA037CAFEB93238D49FEAB319C075B1BC41F72428B7F6145A466D5BDC325C4F222698D9D158622D4AA9F635A743D6BDBED207E9898FC7EA378A3E585F7E02B37EE96F70EB2F1C8FB759FE7DC0CD956DC4880ECE6C9823742B4906C361987087EA75A8D2EEDED6EDA03EA3BA567E7C6FD92A9E4A850418AA279EF9C24956D6810CBD42987C13B1E0E86FA730658AE7605D353F09D6F6DBC18DE7FF73FBA0D666E2A82BC82FBF02948A7F2B01038A8430F3CCCF5F07D41333E923337F48B6FCF30546FCCFE1ED18DB193EBB971ADB47829D36B6B747CBE1A1DC4CDFBD63B9AA2E643BD748BC62E9E602D3640626D74662514E54C6538605FCEC29BE5DFD11ED7FDB4463B07CD141F82F1D05A92FAB0EB4D199A85C37F1474FFB8C1A95E1F18063781CEC0AD32767A9C3E514AC5DDF0FBF3051FA3129E7904DD47DE98AD25D590B722E567D7F237A78FFF555659373745FF837FB122E204DEE33EA5EFD5D7291B5BC6F7664D41E089F3B1F00E5EB7685F763845BAC5AA43BAD8E04AAC3378602946F0F0F200B8160F65E25EC099EC30D2F9B1F61C1D255D3C4F783FCF82036C31E8D395B18266D8DD1D9FBEF75EA3FD8DFFD070930E145E20F0000 , N'6.1.3-40302')
END


GO
